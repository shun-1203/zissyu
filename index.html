<script>
const liffId = "2008097109-4gW3w9Xg"; // あなたのLIFF ID
const gasUrl = "https://script.google.com/macros/s/AKfycbw23uPaE8shM_zCuk0j6QE6RbaNm0cFfh8hWZwMkdtmviuHfX1uajWSyD-tEhNcH-il/exec"; // デプロイしたGAS URL

let userName = "匿名";

// LIFF初期化
async function main() {
  await liff.init({ liffId });
  if (!liff.isLoggedIn()) liff.login();
}
main();

// プロフィール取得
document.getElementById("getProfile").onclick = async () => {
  try {
    const profile = await liff.getProfile();
    userName = profile.displayName;
    document.getElementById("profile").innerHTML =
      `<p>こんにちは、${userName} さん！</p>
       <img src="${profile.pictureUrl}" width="80" class="rounded-circle">`;
  } catch (err) {
    alert("プロフィール取得に失敗: " + err);
    console.error(err);
  }
};

// 一覧取得
async function loadList() {
  try {
    const res = await fetch(gasUrl);
    const items = await res.json();
    const list = document.getElementById("list");
    list.innerHTML = "";
    items.forEach((data) => {
      list.innerHTML += `
        <div class="list-group-item">
          <strong>${data.item}</strong>（${data.place}）
          <br><small>by ${data.user} / ${data.date}</small>
        </div>`;
    });
  } catch (err) {
    console.error("一覧取得に失敗:", err);
  }
}

// 登録処理
document.getElementById("form").onsubmit = async (e) => {
  e.preventDefault();
  const item = document.getElementById("item").value;
  const place = document.getElementById("place").value;
  const date = new Date().toLocaleString();

  const data = { item, place, user: userName, date };

  try {
    const res = await fetch(gasUrl, {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) throw new Error("HTTPエラー: " + res.status);

    loadList(); // 登録後に一覧を更新
    e.target.reset();
  } catch (err) {
    alert("登録に失敗しました: " + err.message);
    console.error(err);
  }
};

loadList();
</script>
